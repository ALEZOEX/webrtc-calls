<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Conference</title>
  <link rel="stylesheet" href="/style.css?v=3.2" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <header class="header">
    <div class="logo">
      <h3>üé• Video Conference</h3>
   </div>
    <div class="room-info">
      <i class="fas fa-door-open"></i>
      <span>Room:</span>
      <code id="room-code"><%= roomId.substring(0, 8) %>...</code>
    </div>
  </header>

  <main class="main">
    <section class="main__left">
      <div id="video-grid" class="video-grid"></div>
      
      <div class="control-panel">
        <button id="stopVideo" class="control-button" title="–ö–∞–º–µ—Ä–∞">
          <i class="fas fa-video-slash"></i>
        </button>
        <button id="muteButton" class="control-button" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="screenShareButton" class="control-button" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞">
          <i class="fas fa-desktop"></i>
        </button>
        <button id="whiteboardButton" class="control-button" title="–î–æ—Å–∫–∞">
          <i class="fas fa-chalkboard"></i>
        </button>
        <button id="inviteButton" class="control-button" title="–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å">
          <i class="fas fa-user-plus"></i>
        </button>
        <button id="toggleChat" class="control-button" title="–ß–∞—Ç">
          <i class="fas fa-comments"></i>
        </button>
        <button id="exit-conference-btn" class="control-button danger" title="–í—ã–π—Ç–∏">
          <i class="fas fa-phone-slash"></i>
        </button>
      </div>
    </section>

    <section class="main__right" id="chat-panel">
      <div class="chat-panel">
        <h3>üí¨ –ß–∞—Ç</h3>
        <div class="messages"></div>
        <div class="chat-input-container">
          <input id="chat_message" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" maxlength="500" />
          <button id="send" class="chat-send-button">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <div class="emoji-buttons">
          <button class="emoji-button" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
          <button class="emoji-button" data-emoji="üëç">üëç</button>
          <button class="emoji-button" data-emoji="üëé">üëé</button>
          <button class="emoji-button" data-emoji="üòÇ">üòÇ</button>
          <button class="emoji-button" data-emoji="üò±">üò±</button>
          <button class="emoji-button" data-emoji="üòé">üòé</button>
          <button class="emoji-button" data-emoji="üéâ">üéâ</button>
          <button class="emoji-button" data-emoji="üëè">üëè</button>
        </div>
      </div>
    </section>
  </main>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  
  <script>
  const ROOM_ID = "<%= roomId %>";

  //STUN + TURN (OpenRelay ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π, –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω–æ—Ä–º)
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π PeerJS —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ª—É—á—à–µ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  const PEER_CONFIG = {
    host: window.location.hostname,
    port: window.location.port? parseInt(window.location.port) : (window.location.protocol === 'https:' ? 443 : 80),
    path: '/peerjs',
    secure: window.location.protocol === 'https:',
    config: {
      iceServers: [
        // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        { urls: 'stun:stun3.l.google.com:19302' },

        // TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –æ–±—Ö–æ–¥–∞ NAT
        { urls: 'turn:openrelay.metered.ca:80',   username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443',  username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:3478', username: 'openrelayproject', credential: 'openrelayproject' }
      ],
      sdpSemantics: 'unified-plan',
      iceTransportPolicy: isMobile ? 'all' : 'all', // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–±—É–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
      bundlePolicy: 'max-bundle',
      rtcpMuxPolicy: 'require'
    }
  };

  if (isMobile) {
    console.log('üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WebRTC');
  }

  console.log('üîß Room ID:', ROOM_ID);
  console.log('üîß PeerJS Config:', PEER_CONFIG);
</script>
  
  <script src="/script.js?v=3.2"></script>
<script src="/whiteboard.js?v=3.2"></script>
</body>
</html>